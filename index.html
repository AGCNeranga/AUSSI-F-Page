<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LS Publication - Australia Horse Races</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* 3D VIP LOOK - USER COLOURS */
    :root {
      --dark-green: #051a05;
      --light-green: #28a745;
      --yellow: #ffc107;
      --white: #ffffff;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-image: url('https://content.api.news/v3/images/bin/996141cf1b184ec8c087e484e2aa961e');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      min-height: 100vh;
      color: var(--white);
    }

    .overlay {
      background: linear-gradient(135deg, rgba(5, 26, 5, 0.92), rgba(0, 0, 0, 0.8));
      min-height: 100vh;
      padding: 40px 15px;
    }

    .password-screen, .glass-panel {
      max-width: 850px;
      margin: 40px auto;
      padding: 40px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6), inset 0 0 15px rgba(255, 255, 255, 0.05);
      transform: perspective(1000px) rotateX(1deg);
    }

    .password-screen { max-width: 450px; text-align: center; margin-top: 80px; }

    .company-logo {
      width: 180px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 10px var(--yellow));
    }

    .input-glass {
      background: rgba(255, 255, 255, 0.95) !important;
      border: none;
      color: #000 !important;
      font-weight: 600;
      border-radius: 10px;
    }

    .btn-vip {
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 0 rgba(0,0,0,0.5);
      transition: 0.2s;
    }

    .btn-vip:active {
      transform: translateY(4px);
      box-shadow: 0 1px 0 rgba(0,0,0,0.5);
    }

    .btn-green { background: var(--light-green); color: white; }
    .btn-yellow { background: var(--yellow); color: #000; border: 2px solid var(--white); }
    .btn-red { background: #dc3545; color: white; }
    .btn-white { background: var(--white); color: #000; }

    .race-block {
      background: rgba(0, 0, 0, 0.7);
      border-left: 8px solid var(--yellow);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 8px 8px 20px rgba(0,0,0,0.5);
      cursor: grab;
      user-select: none;
      transition: transform 0.2s, background 0.2s;
    }
    
    .race-block:active { cursor: grabbing; }
    .race-block.dragging { opacity: 0.5; background: rgba(40, 167, 69, 0.3); }

    .race-meeting { color: var(--yellow); font-size: 1.4rem; font-weight: 900; pointer-events: none;}
    .race-time { color: #17a2b8; font-weight: bold; font-family: monospace; font-size: 1.1rem; pointer-events: none;}

    .container-main { display: none; }

    footer {
      text-align: center;
      color: var(--yellow);
      padding: 30px;
      background: #000;
      border-top: 3px solid var(--yellow);
      margin-top: 50px;
    }
  </style>
</head>
<body>

<div class="overlay">
  <div id="passwordScreen" class="password-screen">
    <img src="https://leisuresportsholdings.com/images/logolg.png" alt="Logo" class="company-logo">
    <h2 style="color: var(--yellow);">AUSTRALIA ELIGIBLE RACES</h2>
    <img src="https://st.depositphotos.com/1313626/54427/i/450/depositphotos_544271302-stock-illustration-three-racing-horses-competing-with.jpg" class="img-fluid rounded mb-4" width="250">
    <input type="password" id="password" class="form-control input-glass mb-3" placeholder="Enter Password..." />
    <button class="btn btn-vip btn-green w-100" onclick="checkPassword()">Unlock VIP Access</button>
  </div>

  <div id="mainContent" class="container container-main">
    <div class="glass-panel">
      <h2 class="mb-4 d-flex align-items-center">
        <img src="https://leisuresportsholdings.com/images/logolg.png" height="50" class="me-3">
        Australia Race Dashboard
      </h2>

      <textarea id="raceText" rows="10" class="form-control input-glass mb-3" placeholder="Paste race card text here..."></textarea>
      
      <div class="row g-2 mb-3">
        <div class="col-md-6">
          <input type="file" id="raceFile1" class="form-control input-glass" accept=".txt" multiple />
        </div>
        <div class="col-md-6">
          <input type="text" id="meetingsInput" class="form-control input-glass" placeholder="Filter Meetings (e.g. GEELONG, COROWA)" />
        </div>
      </div>

      <div class="row g-2 mb-4">
        <div class="col"><input type="number" id="minPrize" class="form-control input-glass" placeholder="Min Prize ($)" /></div>
        <div class="col"><input type="number" id="maxPrize" class="form-control input-glass" placeholder="Max Prize ($)" /></div>
      </div>

      <div class="d-flex flex-wrap gap-3 justify-content-center">
        <button class="btn btn-vip btn-green px-4" onclick="processText()">Process & Filter</button>
        <button class="btn btn-vip btn-yellow" onclick="showMeetingRace1s()">Meeting Race 1s</button>
        <button class="btn btn-vip btn-white" onclick="downloadOutput()">Download TXT</button>
        <button class="btn btn-vip btn-red" onclick="clearAll()">Clear All</button>
      </div>

      <div id="output" class="mt-5"></div>
    </div>
  </div>
</div>

<footer>
  <p>Â© 2026 | LS Publication Dept. | Developed by Charith Neranga</p>
</footer>

<script>
let lastRaces = [];

function checkPassword() {
  const entered = document.getElementById("password").value;
  if (entered === "lal1234") {
    document.getElementById("passwordScreen").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
  } else {
    alert("Incorrect password!");
  }
}

document.getElementById("password").addEventListener("keypress", (e) => {
  if (e.key === "Enter") checkPassword();
});

document.getElementById('raceFile1').addEventListener('change', function(e) {
  const files = e.target.files;
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = (evt) => {
      document.getElementById('raceText').value += evt.target.result + '\n';
    };
    reader.readAsText(file);
  });
});

// Helper for Leading Zero 12h Time WITHOUT AM/PM
function format12hNoLabel(timeStr) {
  if (!timeStr || timeStr === 'N/A') return 'N/A';
  let [hours, minutes] = timeStr.split(':');
  hours = parseInt(hours);
  hours = hours % 12;
  hours = hours ? hours : 12; 
  
  const formattedHours = hours.toString().padStart(2, '0');
  const formattedMinutes = minutes.padStart(2, '0');
  
  return formattedHours + ':' + formattedMinutes;
}

function processText() {
  const text = document.getElementById('raceText').value;
  const minPrize = parseInt(document.getElementById('minPrize').value || 0);
  const maxPrize = parseInt(document.getElementById('maxPrize').value || 999999999);
  const meetingsRaw = document.getElementById('meetingsInput').value;
  const meetingsFilter = meetingsRaw ? meetingsRaw.split(',').map(m => m.trim().toUpperCase()) : [];

  if (!text.trim()) { alert('Please enter data first.'); return; }

  const lines = text.split(/\r?\n/);
  let races = [];
  let currentMeeting = '';

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (line.includes('@Cour:')) {
      const courMatch = line.match(/@Cour:\s*([A-Za-z\s]+)/);
      currentMeeting = courMatch ? courMatch[1].trim().toUpperCase() : '';
    } else if (line.includes('@Heading :')) {
      const headingMatch = line.match(/@Heading\s*:\s*([A-Za-z]+)/);
      currentMeeting = headingMatch ? headingMatch[1].trim().toUpperCase() : '';
    }

    if (line.startsWith('@Race:') || line.startsWith('@Course :')) {
      const cleanLine = line.replace('@Race:', '').replace('@Course :', '').trim();
      const raceMatch = cleanLine.match(/^(\S+)\s+(\d{1,2}:\d{2})\s*\(?(\d{1,2}:\d{2})?\)?/);
      
      if (raceMatch) {
        const fullRaceId = raceMatch[1];
        const raceNum = fullRaceId.split('/')[1] || "1";
        const ausiTime = format12hNoLabel(raceMatch[2]);
        const slTime = format12hNoLabel(raceMatch[3] || 'N/A');
        const prizeMatch = cleanLine.match(/\$([\d,]+)/);
        const prize = prizeMatch ? parseInt(prizeMatch[1].replace(/,/g, '')) : 0;
        
        if (meetingsFilter.length && !meetingsFilter.includes(currentMeeting)) continue;
        if (prize < minPrize || prize > maxPrize) continue;

        races.push({ meeting: currentMeeting, raceNumber: raceNum, ausiTime: ausiTime, slTime: slTime, prize: prize });
      }
    }
  }
  lastRaces = races;
  displayRaces(races);
}

function displayRaces(races) {
  const output = document.getElementById('output');
  output.innerHTML = races.map(r => `
    <div class="race-block" draggable="true" data-meeting="${r.meeting}" data-ausi="${r.ausiTime}" data-sl="${r.slTime}">
      <div class="race-meeting">${r.meeting} - Race ${r.raceNumber}</div>
      <div class="race-time">${r.ausiTime} (${r.slTime})</div>
    </div>
  `).join('');
  initDragAndDrop();
}

function showMeetingRace1s() {
  if (!lastRaces.length) { alert("Please process data first."); return; }
  const meetingsProcessed = new Set();
  const race1s = [];
  
  lastRaces.forEach(r => {
    if (parseInt(r.raceNumber) === 1 && !meetingsProcessed.has(r.meeting)) {
      meetingsProcessed.add(r.meeting);
      race1s.push(r);
    }
  });

  const output = document.getElementById('output');
  output.innerHTML = `<h4 class="text-center mb-4 text-warning">DRAG TO REORDER MEETINGS</h4>` + race1s.map(r => `
    <div class="race-block" draggable="true" data-meeting="${r.meeting}" data-ausi="${r.ausiTime}" data-sl="${r.slTime}">
      <div class="race-meeting">${r.meeting}</div>
      <div class="race-time">${r.ausiTime} (${r.slTime})</div>
    </div>
  `).join('');
  initDragAndDrop();
}

function initDragAndDrop() {
  const container = document.getElementById('output');
  const blocks = document.querySelectorAll('.race-block');
  blocks.forEach(block => {
    block.addEventListener('dragstart', () => block.classList.add('dragging'));
    block.addEventListener('dragend', () => block.classList.remove('dragging'));
  });
  container.addEventListener('dragover', e => {
    e.preventDefault();
    const afterElement = getDragAfterElement(container, e.clientY);
    const dragging = document.querySelector('.dragging');
    if (afterElement == null) container.appendChild(dragging);
    else container.insertBefore(dragging, afterElement);
  });
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.race-block:not(.dragging)')];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
    else return closest;
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function downloadOutput() {
  const blocks = document.querySelectorAll('.race-block');
  if (blocks.length === 0) { alert("No data to download!"); return; }
  let textContent = "EVERY MEETING - RACE 1 DETAILS\n\n";
  blocks.forEach(block => {
    const meeting = block.getAttribute('data-meeting');
    const ausi = block.getAttribute('data-ausi');
    const sl = block.getAttribute('data-sl');
    if(meeting) textContent += `${meeting}\t${ausi}\t(${sl})\n\n`;
  });
  const blob = new Blob([textContent], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Meeting_Races_Custom_Format.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function clearAll() {
  document.getElementById('raceText').value = '';
  document.getElementById('output').innerHTML = '';
  document.getElementById('meetingsInput').value = '';
  document.getElementById('minPrize').value = '';
  document.getElementById('maxPrize').value = '';
  lastRaces = [];
}
</script>
</body>

</html>
